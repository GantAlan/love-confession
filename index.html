<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>3D Pixel Love (Universal)</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: -apple-system, BlinkMacSystemFont, sans-serif; touch-action: none; }
        #canvas-box { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        
        /* 启动遮罩 (黑色背景) */
        #start-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: white; text-align: center;
        }

        .start-btn {
            background: linear-gradient(135deg, #00e5ff, #ff0088);
            border: none; padding: 15px 40px; border-radius: 50px;
            color: white; font-size: 18px; font-weight: bold; margin-top: 30px;
            box-shadow: 0 0 20px rgba(0,229,255,0.5); cursor: pointer;
        }

        /* 微信提示层 */
        #wx-tip {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 1000; display: none;
            color: #fff; text-align: center; padding-top: 100px; font-size: 18px;
        }

        /* 设置按钮 */
        #gear-btn {
            position: fixed; top: 20px; left: 20px; z-index: 50;
            width: 40px; height: 40px; border-radius: 50%;
            background: rgba(255,255,255,0.1); backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.2); color: white;
            font-size: 20px; display: flex; align-items: center; justify-content: center;
            cursor: pointer;
        }

        /* 设置面板 */
        #settings-panel {
            position: fixed; top: 70px; left: 20px; width: 240px;
            background: rgba(20, 20, 30, 0.95); padding: 15px; border-radius: 12px;
            color: white; z-index: 49; transform: translateX(-150%);
            transition: transform 0.3s; border: 1px solid #333;
        }
        #settings-panel.active { transform: translateX(0); }
        
        .control-row { margin-bottom: 15px; }
        label { display: block; font-size: 12px; color: #aaa; margin-bottom: 5px; }
        input[type="range"] { width: 100%; }
        input[type="color"] { width: 45%; height: 30px; border: none; padding: 0; background: none; }
        textarea { width: 100%; background: #222; border: 1px solid #444; color: white; padding: 5px; box-sizing: border-box;}

        /* 下一句按钮 */
        #next-btn {
            position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%);
            padding: 12px 35px; background: rgba(255,255,255,0.15); 
            border: 1px solid rgba(255,255,255,0.3); backdrop-filter: blur(5px);
            color: white; border-radius: 30px; font-size: 16px; z-index: 20;
        }

        /* 隐藏的视频元素 */
        #video-feed { display: none; }
        
        /* 调试信息 */
        #log-msg {
            position: fixed; bottom: 10px; left: 10px; font-size: 10px; color: #666; z-index: 5; pointer-events: none;
        }
    </style>
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
</head>
<body>

    <div id="wx-tip">
        <p>⚠️ 微信/QQ 内无法调用摄像头</p>
        <p>请点击右上角 ... 选择</p>
        <p style="color:#00e5ff; font-weight:bold">在浏览器打开</p>
    </div>

    <div id="start-screen">
        <h1 style="font-weight: 300;">3D Pixel Love</h1>
        <p style="font-size: 12px; color: #888;">Universal Edition</p>
        <button class="start-btn" id="btn-start">点击开始 (Start)</button>
        <div id="status-text" style="margin-top: 15px; font-size: 12px; color: #ff3333;"></div>
    </div>

    <div id="gear-btn">⚙️</div>
    <div id="settings-panel">
        <div class="control-row">
            <label>文字内容 (每行一句最多四句)<br>张开手掌 = 文字<br>捏合手指 = 星空</label>
            <textarea id="txt-input" rows="5"></textarea>
        </div>
        <div class="control-row">
            <label>方块大小</label>
            <input type="range" id="rng-size" min="0.1" max="1.5" step="0.1" value="0.6">
        </div>
        <div class="control-row">
            <label>渐变色</label>
            <input type="color" id="col-a" value="#00e5ff">
            <input type="color" id="col-b" value="#ff0088">
        </div>
        <div class="control-row">
            <button id="btn-fullscreen" style="width:100%; padding:8px; background:#333; color:white; border:1px solid #555; border-radius:5px;">全屏显示</button>
        </div>
    </div>

    <button id="next-btn">下一句 ✨</button>
    <div id="log-msg">Ready.</div>
    
    <video id="video-feed" playsinline muted autoplay></video>
    <div id="canvas-box"></div>

    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }
    </script>

    <script type="module">
        import * as THREE from 'three';

        // --- 全局变量 ---
        const CONFIG = { count: 18000 }; // 粒子数量
        const STATE = {
            targetExp: 1.0, // 目标扩散度 (1=散, 0=聚)
            currentExp: 1.0,
            cubeSize: 0.6,
            colA: new THREE.Color('#00e5ff'),
            colB: new THREE.Color('#ff0088'),
            msgs: ["Ready?", "Hi ", "看这里", "张开手", "给你看", "我的", "❤️"]
        };
        let msgIndex = 0;
        let scene, camera, renderer, mesh;

        // --- 工具：日志与检测 ---
        function log(t) { 
            console.log(t); 
            document.getElementById('log-msg').innerText = t; 
        }

        // 检测微信/QQ
        const ua = navigator.userAgent.toLowerCase();
        if(ua.match(/MicroMessenger/i) || ua.match(/QQ/i)) {
            document.getElementById('wx-tip').style.display = 'block';
        }

        // --- 1. Three.js 初始化 ---
        function init3D() {
            const container = document.getElementById('canvas-box');
            scene = new THREE.Scene();
            scene.background = new THREE.Color('#050505');

            camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 100);
            camera.position.z = window.innerWidth < window.innerHeight ? 20 : 14; // 手机端拉远

            renderer = new THREE.WebGLRenderer({ antialias: true, powerPreference: "high-performance" });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            container.appendChild(renderer.domElement);

            createMesh();
            updateText(STATE.msgs[1]); // 预加载第一句
            msgIndex = 1;

            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth/window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });

            animate();
        }

        // --- 2. 粒子网格 ---
        const data = {
            target: new Float32Array(CONFIG.count * 3),
            scatter: new Float32Array(CONFIG.count * 3)
        };

        function createMesh() {
            // 预计算散点
            for(let i=0; i<CONFIG.count; i++) {
                const r = 10 + Math.random() * 30;
                const theta = Math.random() * Math.PI * 2;
                const phi = Math.acos(2 * Math.random() - 1);
                data.scatter[i*3] = r * Math.sin(phi) * Math.cos(theta);
                data.scatter[i*3+1] = r * Math.sin(phi) * Math.sin(theta);
                data.scatter[i*3+2] = r * Math.cos(phi) * 0.5;
            }

            const geo = new THREE.InstancedBufferGeometry();
            const base = new THREE.BoxGeometry(1,1,1);
            geo.index = base.index;
            geo.attributes.position = base.attributes.position;
            geo.attributes.normal = base.attributes.normal;
            geo.setAttribute('aTarget', new THREE.InstancedBufferAttribute(data.target, 3));
            geo.setAttribute('aScatter', new THREE.InstancedBufferAttribute(data.scatter, 3));
            
            const rands = new Float32Array(CONFIG.count);
            for(let i=0; i<CONFIG.count; i++) rands[i] = Math.random();
            geo.setAttribute('aRandom', new THREE.InstancedBufferAttribute(rands, 1));

            const mat = new THREE.ShaderMaterial({
                uniforms: {
                    uTime: { value: 0 },
                    uExp: { value: 1.0 },
                    uSize: { value: STATE.cubeSize },
                    uColA: { value: STATE.colA },
                    uColB: { value: STATE.colB }
                },
                vertexShader: `
                    uniform float uTime; uniform float uExp; uniform float uSize;
                    uniform vec3 uColA; uniform vec3 uColB;
                    attribute vec3 aTarget; attribute vec3 aScatter; attribute float aRandom;
                    varying vec3 vColor;
                    mat4 rot(vec3 axis, float angle) {
                        axis=normalize(axis); float s=sin(angle); float c=cos(angle); float oc=1.0-c;
                        return mat4(oc*axis.x*axis.x+c, oc*axis.x*axis.y-axis.z*s, oc*axis.z*axis.x+axis.y*s, 0.0,
                                    oc*axis.x*axis.y+axis.z*s, oc*axis.y*axis.y+c, oc*axis.y*axis.z-axis.x*s, 0.0,
                                    oc*axis.z*axis.x-axis.y*s, oc*axis.y*axis.z+axis.x*s, oc*axis.z*axis.z+c, 0.0,
                                    0.0,0.0,0.0,1.0);
                    }
                    void main(){
                        float s = smoothstep(0.0, 1.0, uExp);
                        vec3 pos = mix(aTarget, aScatter, s);
                        pos += vec3(sin(uTime*3.0+aRandom*10.0)*0.1*s);
                        mat4 rm = rot(normalize(vec3(aRandom,1.0,0.0)), uTime*(1.0+s*2.0)+aRandom*10.0);
                        vec3 p = position * uSize;
                        p = (rm * vec4(p,1.0)).xyz + pos;
                        gl_Position = projectionMatrix * modelViewMatrix * vec4(p, 1.0);
                        float g = smoothstep(-6.0, 6.0, pos.x);
                        vec3 c = mix(uColA, uColB, g);
                        vec3 n = (rm * vec4(normal,0.0)).xyz;
                        float l = max(dot(n, normalize(vec3(0.5,1.0,1.0))), 0.3);
                        vColor = c * (l+0.4);
                    }
                `,
                fragmentShader: `varying vec3 vColor; void main(){gl_FragColor=vec4(vColor,1.0);}`
            });

            mesh = new THREE.Mesh(geo, mat);
            mesh.frustumCulled = false;
            scene.add(mesh);
        }

        function updateText(text) {
            const W=500, H=250;
            const cvs = document.createElement('canvas'); cvs.width=W; cvs.height=H;
            const ctx = cvs.getContext('2d');
            ctx.fillStyle='#000'; ctx.fillRect(0,0,W,H);
            ctx.fillStyle='#fff'; ctx.font='900 100px sans-serif';
            ctx.textAlign='center'; ctx.textBaseline='middle';
            ctx.fillText(text, W/2, H/2);
            
            const img = ctx.getImageData(0,0,W,H).data;
            const pts=[];
            for(let y=0; y<H; y+=4) {
                for(let x=0; x<W; x+=4) {
                    if(img[(y*W+x)*4]>100) pts.push((x-W/2)*0.045, -(y-H/2)*0.045, 0);
                }
            }
            const attr = mesh.geometry.attributes.aTarget;
            for(let i=0; i<CONFIG.count; i++) {
                if(pts.length===0) break;
                const p = i % (pts.length/3);
                attr.setXYZ(i, pts[p*3], pts[p*3+1], pts[p*3+2]+(Math.random()-0.5)*0.5);
            }
            attr.needsUpdate = true;
        }

        // --- 3. 摄像头逻辑 (Universal) ---
        async function startApp() {
            document.getElementById('btn-start').disabled = true;
            document.getElementById('btn-start').innerText = "正在启动...";

            // 0. 环境检测
            if(window.location.protocol !== 'https:' && window.location.hostname !== 'localhost') {
                alert("❌ 必须使用 HTTPS 协议！\n(例如 GitHub Pages)");
                enableFallback("非 HTTPS 环境");
                return;
            }

            const video = document.getElementById('video-feed');
            let stream = null;

            try {
                // 1. 请求摄像头 (最简单的参数，兼容性最好)
                log("Requesting camera...");
                try {
                    // 优先尝试前置 (mobile)
                    stream = await navigator.mediaDevices.getUserMedia({
                        video: { facingMode: 'user' },
                        audio: false
                    });
                } catch(e) {
                    log("Front cam failed, trying any...");
                    // 失败则尝试任意 (desktop)
                    stream = await navigator.mediaDevices.getUserMedia({
                        video: true,
                        audio: false
                    });
                }

                log("Stream obtained.");
                video.srcObject = stream;
                await video.play();

                // 2. 加载 AI
                log("Loading AI...");
                const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
                hands.setOptions({
                    maxNumHands: 1, modelComplexity: 0, 
                    minDetectionConfidence: 0.5, minTrackingConfidence: 0.5
                });
                
                hands.onResults(onHandResults);

                // 3. 循环
                async function loop() {
                    if(video.readyState >= 2) await hands.send({image: video});
                    requestAnimationFrame(loop);
                }
                loop();

                // 成功
                document.getElementById('start-screen').style.display = 'none';

            } catch(err) {
                console.error(err);
                alert("摄像头启动失败: " + err.name + "\n即将切换为触摸/鼠标模式。");
                enableFallback("摄像头不可用");
            }
        }

        function onHandResults(res) {
            if(res.multiHandLandmarks.length > 0) {
                const lm = res.multiHandLandmarks[0];
                const d = Math.sqrt(Math.pow(lm[4].x-lm[8].x,2) + Math.pow(lm[4].y-lm[8].y,2));
                // d大(手指张开)=0(文字), d小(手指捏合)=1(星空)
                let val = THREE.MathUtils.smoothstep(d, 0.02, 0.2);
                STATE.targetExp = 1.0 - val;
            }
        }

        // 降级模式 (鼠标/触摸)
        function enableFallback(reason) {
            log("Fallback mode: " + reason);
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('log-msg').innerText = "⚠️ 触摸模式 (上下滑动)";
            
            const handler = (y) => STATE.targetExp = THREE.MathUtils.clamp(y, 0, 1);
            document.addEventListener('mousemove', e => handler(e.clientY/window.innerHeight));
            document.addEventListener('touchmove', e => handler(e.touches[0].clientY/window.innerHeight));
        }

        function animate() {
            requestAnimationFrame(animate);
            // 缓动
            STATE.currentExp += (STATE.targetExp - STATE.currentExp) * 0.1;

            if(mesh) {
                mesh.material.uniforms.uTime.value = performance.now()*0.001;
                mesh.material.uniforms.uExp.value = STATE.currentExp;
                mesh.material.uniforms.uSize.value = STATE.cubeSize;
                mesh.material.uniforms.uColA.value = STATE.colA;
                mesh.material.uniforms.uColB.value = STATE.colB;
            }
            scene.rotation.y = Math.sin(performance.now()*0.0002) * 0.1;
            renderer.render(scene, camera);
        }

        // --- UI 事件绑定 ---
        document.getElementById('btn-start').addEventListener('click', startApp);
        
        // 设置面板
        const panel = document.getElementById('settings-panel');
        document.getElementById('gear-btn').addEventListener('click', (e) => {
            e.stopPropagation(); panel.classList.toggle('active');
        });
        document.addEventListener('click', (e) => {
            if(!panel.contains(e.target) && e.target.id !== 'gear-btn') panel.classList.remove('active');
        });

        // 控件
        document.getElementById('txt-input').value = STATE.msgs.join('\n');
        document.getElementById('txt-input').addEventListener('input', (e) => {
            STATE.msgs = e.target.value.split('\n').filter(s=>s.trim());
            msgIndex = Math.min(msgIndex, STATE.msgs.length-1);
        });

        document.getElementById('rng-size').addEventListener('input', (e) => STATE.cubeSize = parseFloat(e.target.value));
        document.getElementById('col-a').addEventListener('input', (e) => STATE.colA.set(e.target.value));
        document.getElementById('col-b').addEventListener('input', (e) => STATE.colB.set(e.target.value));

        document.getElementById('btn-fullscreen').addEventListener('click', () => {
            !document.fullscreenElement ? document.documentElement.requestFullscreen() : document.exitFullscreen();
        });

        document.getElementById('next-btn').addEventListener('click', () => {
            msgIndex = (msgIndex + 1) % STATE.msgs.length;
            if(STATE.msgs.length > 0) updateText(STATE.msgs[msgIndex]);
        });

        // 启动
        init3D();

    </script>
</body>
</html>
